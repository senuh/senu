//================= IMPORTS =================
const { cmd } = require('../lib/command');
const fs = require('fs');
const path = require('path');
const axios = require('axios');
const yts = require('yt-search');
const ffmpegPath = require('@ffmpeg-installer/ffmpeg').path;
const ffmpeg = require('fluent-ffmpeg');
ffmpeg.setFfmpegPath(ffmpegPath);

//================= GLOBALS =================
let autoSongIntervals = {};
let playedSongs = {};
let lastQueryPerChat = {};
const OWNER_JID = "94760264995@s.whatsapp.net"; // <-- Replace with your number

const styles = [
  "sinhala slowed reverb song",
  "sinhala love slowed song",
  "sinhala vibe slowed song",
  "sinhala sad slowed song",
  "sinhala 2024 slowed song",
  "sinhala mashup slowed reverb",
];

//================= HELPERS =================
async function downloadFile(url, outputPath) {
  const writer = fs.createWriteStream(outputPath);
  const response = await axios.get(url, { responseType: "stream" });
  response.data.pipe(writer);
  return new Promise((resolve, reject) => {
    writer.on("finish", resolve);
    writer.on("error", reject);
  });
}

async function convertToOpus(inputPath, outputPath) {
  return new Promise((resolve, reject) => {
    ffmpeg(inputPath)
      .audioCodec("libopus")
      .audioBitrate("64k")
      .format("opus")
      .on("end", resolve)
      .on("error", reject)
      .save(outputPath);
  });
}

//================= MOOD DETECTION =================
function detectMood(text) {
  text = text.toLowerCase();
  if (text.includes("sad") || text.includes("broken") || text.includes("lonely")) return "sad";
  if (text.includes("love") || text.includes("heart") || text.includes("romantic")) return "love";
  if (text.includes("vibe") || text.includes("slow") || text.includes("chill")) return "vibe";
  if (text.includes("party") || text.includes("beat") || text.includes("mashup")) return "party";
  return "default";
}

const moodStyles = {
  sad: {
    emoji: "ü•Ä",
    footer: "üñ§ Sad Vibe Mode ‚Ä¢ ZANTA-XMD BOT",
    sticker: "https://i.ibb.co/6sxHn8V/sadvibe.webp",
  },
  love: {
    emoji: "üíû",
    footer: "üíò Love Mood ‚Ä¢ ZANTA-XMD BOT",
    sticker: "https://i.ibb.co/pzfMG1K/lovemood.webp",
  },
  vibe: {
    emoji: "üåô",
    footer: "üéß Chill Vibe Mode ‚Ä¢ ZANTA-XMD BOT",
    sticker: "https://i.ibb.co/Y2k6JcN/musicvibe.webp",
  },
  party: {
    emoji: "üéâ",
    footer: "‚ö° Party Energy ‚Ä¢ ZANTA-XMD BOT",
    sticker: "https://i.ibb.co/MsK4VNG/partybeat.webp",
  },
  default: {
    emoji: "üé∂",
    footer: "üéµ Sinhala Vibe Menu ‚Ä¢ ZANTA-XMD BOT",
    sticker: "https://i.ibb.co/sVKr0fj/defaultvibe.webp",
  },
};

//================= MAIN SONG FUNCTION =================
async function sendSinhalaSong(conn, jid, reply, query) {
  try {
    lastQueryPerChat[jid] = query;
    const search = await yts(query);
    const video = search.videos.find(v => v.seconds <= 480);
    if (!video) return reply("üò≠ ‡∑É‡∑î‡∂Ø‡∑î‡∑É‡∑î ‡∑É‡∑í‡∂±‡∑ä‡∂Ø‡∑î‡∑Ä‡∂ö‡∑ä ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑î‡∂´‡∑è.");

    if (!playedSongs[jid]) playedSongs[jid] = new Set();
    if (playedSongs[jid].has(video.videoId)) return sendSinhalaSong(conn, jid, reply, query);
    playedSongs[jid].add(video.videoId);
    if (playedSongs[jid].size > 20) playedSongs[jid].clear();

    const mood = detectMood(video.title);
    const moodSet = moodStyles[mood] || moodStyles.default;

    const caption = `${moodSet.emoji} *${video.title}* ${moodSet.emoji}

üíÜ‚Äç‚ôÇÔ∏è ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω Mind Relaxing Song
üéß ‡∑Ñ‡∑ú‡∂≥ vibe ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ø‡∑ê‡∂±‡∂ú‡∂±‡∑ä‡∂± Headphones ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ö‡∂±‡∑í‡∑Ä‡∑è‡∂ª‡∑ä‡∂∫‡∂∫‡∑í!
‚ö° Powered by ZANTA-XMD BOT`;

    await conn.sendMessage(jid, {
      image: { url: video.thumbnail },
      caption,
      footer: moodSet.footer,
      buttons: [
        { buttonId: ".nextsong", buttonText: { displayText: "üéµ Next Song" }, type: 1 },
        { buttonId: ".groupsong", buttonText: { displayText: "üë• Group Auto Mode" }, type: 1 },
        { buttonId: ".stop3", buttonText: { displayText: "‚õî Stop Auto" }, type: 1 },
        { buttonId: ".clickhere", buttonText: { displayText: "üéõ Music Settings" }, type: 1 },
      ],
      headerType: 4,
    });

    // ===== Download & Convert =====
    const apiUrl = `https://sadiya-tech-apis.vercel.app/download/ytdl?url=${encodeURIComponent(video.url)}&format=mp3&apikey=sadiya`;
    const { data } = await axios.get(apiUrl);
    if (!data.status || !data.result?.download) return reply("‚ö†Ô∏è mp3 link ‡∂ë‡∂ö ‡∂ú‡∂±‡∑ä‡∂± ‡∂∂‡∑ê‡∂ª‡∑í ‡∂ã‡∂±‡∑è.");

    const unique = `${Date.now()}-${Math.random().toString(36).slice(2)}`;
    const mp3Path = path.join(__dirname, `${unique}.mp3`);
    const opusPath = path.join(__dirname, `${unique}.opus`);

    await downloadFile(data.result.download, mp3Path);
    await convertToOpus(mp3Path, opusPath);

    // üé§ Send as voice note
    await conn.sendMessage(jid, {
      audio: fs.readFileSync(opusPath),
      mimetype: "audio/ogg; codecs=opus",
      ptt: true,
    });

    // üßπ Cleanup
    try { fs.unlinkSync(mp3Path); } catch {}
    try { fs.unlinkSync(opusPath); } catch {}

    // üé≠ Send Mood Sticker Automatically
    setTimeout(async () => {
      await conn.sendMessage(jid, {
        sticker: { url: moodSet.sticker }
      });
    }, 2000);

    // üí¨ Send feedback buttons 3s later
    setTimeout(async () => {
      await conn.sendMessage(jid, {
        text: `${moodSet.emoji} ‡∂î‡∂∫‡∑è‡∂ß ‡∂∏‡∑ö ‡∑É‡∑í‡∂±‡∑ä‡∂Ø‡∑î‡∑Ä ‡∂ö‡∑ú‡∑Ñ‡∑ú‡∂∏‡∂Ø?`,
        footer: moodSet.footer,
        buttons: [
          { buttonId: `.feedback good ${video.title}`, buttonText: { displayText: "ü©∑ ‡∑Ñ‡∑ú‡∂≥‡∂∫‡∑í" }, type: 1 },
          { buttonId: `.feedback bad ${video.title}`, buttonText: { displayText: "üíî ‡∑Ñ‡∑ú‡∂≥ ‡∂±‡∑ë" }, type: 1 },
        ],
        headerType: 4,
      });
    }, 3000);

  } catch (err) {
    console.error("Send error:", err);
    const ownerPhone = OWNER_JID.split('@')[0];
    const waLink = `https://wa.me/${ownerPhone}?text=${encodeURIComponent('Hi, I need help with the bot. Error: ' + (err.message || 'unknown'))}`;
    await conn.sendMessage(jid, {
      text: `üò≠ Song ‡∂ë‡∂ö ‡∂∫‡∑Ä‡∂± ‡∑Ä‡∑ô‡∂Ω‡∑è‡∑Ä‡∂ß error ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂ã‡∂±‡∑è.\n\nüìû Owner ‡∂ë‡∂ö‡∂ß Contact ‡∑Ä‡∑ô‡∂±‡∑ä‡∂±:\n${waLink}`,
      buttons: [
        { buttonId: ".retry", buttonText: { displayText: "üîÅ Retry" }, type: 1 },
        { buttonId: ".contactowner", buttonText: { displayText: "üìû Contact Owner" }, type: 1 },
      ],
      headerType: 1,
    });
  }
}

//================= AUTO SINHALA =================
cmd({
  pattern: "sinhalavoice",
  desc: "Auto Sinhala slowed songs every 10 minutes",
  category: "music",
  filename: __filename,
}, async (conn, mek, m, { reply }) => {
  const jid = m.chat;
  if (autoSongIntervals[jid]) return reply("üü° Auto Sinhala mode already running!");
  await conn.sendMessage(jid, {
    text: "üéß *Auto Sinhala Slowed Songs Activated!*\n‡∂î‡∂∫‡∑è‡∂ß ‡∑Ñ‡∑ê‡∂∏ ‡∂∏‡∑í‡∂±‡∑í‡∂≠‡∑ä‡∂≠‡∑î 10‡∂ö‡∂ß‡∂∏ ‡∂±‡∑Ä Sinhala slowed song ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ω‡∑ê‡∂∂‡∑ô‡∂±‡∑Ä‡∑è.",
    footer: "üéµ Sinhala Vibe Menu",
    buttons: [
      { buttonId: ".nextsong", buttonText: { displayText: "üéµ Next Song" }, type: 1 },
      { buttonId: ".stop3", buttonText: { displayText: "‚õî Stop Auto" }, type: 1 },
      { buttonId: ".clickhere", buttonText: { displayText: "üéõ Music Settings" }, type: 1 },
    ],
    headerType: 4,
  });
  const sendRandom = async () => {
    const randomStyle = styles[Math.floor(Math.random() * styles.length)];
    await sendSinhalaSong(conn, jid, reply, randomStyle);
  };
  await sendRandom();
  autoSongIntervals[jid] = setInterval(sendRandom, 10 * 60 * 1000);
});

//================= GROUP AUTO SONG =================
cmd({
  pattern: "groupsong",
  desc: "Activate group auto Sinhala songs mode",
  category: "music",
  filename: __filename,
}, async (conn, mek, m, { reply }) => {
  const jid = m.chat;
  if (autoSongIntervals[jid]) return reply("üü° Group auto mode already active!");
  reply("üë• Group Sinhala Auto Song mode activated!");
  const sendGroup = async () => {
    const randomStyle = styles[Math.floor(Math.random() * styles.length)];
    await sendSinhalaSong(conn, jid, reply, randomStyle);
  };
  await sendGroup();
  autoSongIntervals[jid] = setInterval(sendGroup, 10 * 60 * 1000);
});

//================= NEXT SONG =================
cmd({
  pattern: "nextsong",
  desc: "Play next Sinhala slowed song immediately",
  category: "music",
  filename: __filename,
}, async (conn, mek, m, { reply }) => {
  const jid = m.chat;
  reply("‚úÖ *Next Sinhala slowed song loading...* üéß");
  const randomStyle = styles[Math.floor(Math.random() * styles.length)];
  await sendSinhalaSong(conn, jid, reply, randomStyle);
});

//================= STOP AUTO =================
cmd({
  pattern: "stop3",
  desc: "Stop automatic Sinhala slowed songs",
  category: "music",
  filename: __filename,
}, async (conn, mek, m, { reply }) => {
  const jid = m.chat;
  if (!autoSongIntervals[jid]) return reply("‚ö†Ô∏è Auto mode ‡∂ë‡∂ö ‡∂Ö‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑Ä ‡∂±‡∑ê‡∑Ñ‡∑ê.");
  clearInterval(autoSongIntervals[jid]);
  delete autoSongIntervals[jid];
  reply("üõë Auto Sinhala slowed songs mode ‡∂ë‡∂ö ‡∂±‡∑Ä‡∂≠‡∑è ‡∂Ø‡∂∏‡∂± ‡∂Ω‡∂Ø‡∑í.");
});

//================= MANUAL SONG SEARCH =================
cmd({
  pattern: "song3",
  desc: "Search Sinhala slowed song or trending list",
  category: "music",
  filename: __filename,
}, async (conn, mek, m, { args, reply }) => {
  const jid = m.chat;
  const query = args.join(" ").trim();
  if (query) {
    const q = `${query} sinhala slowed reverb song`;
    reply(`üîç Searching YouTube for *${query} slowed Sinhala song...* üéß`);
    await sendSinhalaSong(conn, jid, reply, q);
    return;
  }
  try {
    const { videos } = await yts("sinhala slowed reverb song");
    if (!videos || videos.length === 0) return reply("‚ö†Ô∏è Sinhala slowed songs ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑î‡∂´‡∑è.");
    const top5 = videos.slice(0, 5);
    const buttons = top5.map(v => ({
      buttonId: `.song3 ${v.title}`,
      buttonText: { displayText: `üéµ ${v.title.slice(0, 25)}...` },
      type: 1,
    }));
    await conn.sendMessage(jid, {
      text: `üéß *Trending Sinhala Slowed Songs* üé∂\n\n‡∂î‡∂∫‡∑è‡∂ß ‡∂ö‡∑ê‡∂∏‡∂≠‡∑í ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂± üëá`,
      footer: "‚ö° Powered by ZANTA-XMD BOT",
      buttons,
      headerType: 4,
    });
  } catch (err) {
    console.error(err);
    reply("‚ùå Sinhala songs list ‡∂ë‡∂ö ‡∂ú‡∂±‡∑ä‡∂± Error ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂ã‡∂±‡∑è.");
  }
});

//================= FEEDBACK SYSTEM =================
cmd({
  pattern: "feedback",
  desc: "Send song feedback to bot owner",
  category: "music",
  filename: __filename,
}, async (conn, mek, m, { args, reply }) => {
  const type = args[0];
  const songName = args.slice(1).join(" ") || "Unknown Song";
  const senderNum = m.sender.split("@")[0];
  const user = m.pushName || senderNum;
  const groupName = m.isGroup ? m.chat : "Private Chat";
  const ownerJid = OWNER_JID;

  let msgText;
  if (type === "good") {
    msgText = `ü©∑ *Feedback Alert!*\nüë§ User: ${user}\nüìû wa.me/${senderNum}\nüí¨ Reaction: Liked the song\nüé∂ Song: ${songName}\nüìç Chat: ${groupName}`;
    await reply("ü©∑ ‡∂î‡∂∂‡∂ú‡∑ö ‡∂Ö‡∂Ø‡∑Ñ‡∑É Owner ‡∂ß ‡∂∫‡∑Ä‡∂± ‡∂Ω‡∂Ø‡∑í ‚úÖ");
  } else if (type === "bad") {
    msgText = `üíî *Feedback Alert!*\nüë§ User: ${user}\nüìû wa.me/${senderNum}\nüí¨ Reaction: Didn't like the song\nüé∂ Song: ${songName}\nüìç Chat: ${groupName}`;
    await reply("üíî ‡∂î‡∂∂‡∂ú‡∑ö ‡∂Ö‡∂Ø‡∑Ñ‡∑É Owner ‡∂ß ‡∂∫‡∑Ä‡∂± ‡∂Ω‡∂Ø‡∑í üò¢");
  } else return reply("‚ö†Ô∏è ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í feedback command ‡∂ë‡∂ö‡∂ö‡∑ä!");

  try {
    await conn.sendMessage(ownerJid, { text: msgText });
  } catch (err) {
    console.error("Error sending feedback to owner:", err);
  }
});